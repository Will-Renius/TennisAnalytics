---
title: "Baseline Gambling Simulations"
author: "Nick Kurtansky"
date: "11/25/2017"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

The purpose of this is to provide the results to the two baseline strategies:
  1. Always betting the favorite
  2. Always betting the underdog
  3. Randomly betting the underdog or favorite
  4. Always betting the higher ranked player
  5. Always betting the lower ranked player
  
I will run this simulation seperately for each of the years from 2001 through 2017 in order to look for trends that may provide insight in how the oddsmakers have adapted over the years.

```{r include = FALSE}
library(ggplot2)
library(tidyr)
library(dplyr)
```

### load in data
```{r}
load("data/clean.men.data.RData")
data <- final.data

head(data,100)
str(data)
```

### Clean Data
```{r}
# only include matches that sports books took bets on
data <- data %>% filter((FcountOdds > 0) & (LcountOdds > 0))

# convert 'upset' to logical and change name: rank.upset
data$upset <- as.logical(data$upset)
names(data)[10] <- "rank.upset"

# upset by odds variable: odds.upset
data$odds.upset <- rep(NA, nrow(data))
for(i in 1:nrow(data)){
  data$odds.upset[i] <- ifelse(data$favorite_won[i] == TRUE, FALSE, TRUE)
}
data$odds.upset <- as.logical(data$odds.upset)

# new column for absolute rank difference variable: rank.dif
data <- data %>% mutate(rank.dif = URank - FRank)

# new column for absolute odds difference variable: odds.dif
data <- data %>% mutate(abs.odds.dif = avgU - avgF)

# new column for variable: year
data$year <- rep(NA, nrow(data))
for(i in 1:nrow(data)){
  year <- substr(x = data$date[i], start = 1, stop = 4)
  data$year[i] <- year
}

str(data)
```

### What is the raw probability of an upset?
```{r}
sum(data$odds.upset/nrow(data))
```

Upset occurs with probability 0.3283341... Hence, odds have a success rate p = 0.6716659


# Simulations

#### Outcome Matrix
Includes:
  Year, strategy, net profit, wins, tries
```{r}
Year <- c(2001:2017)
B1 <- rep("bet fav", times=17)
B2 <- rep("bet dog", times=17)
B3 <- rep("bet random", times=17)
B4 <- rep("bet higher rank", times=17)
B5 <- rep("bet lower rank",times=17)
Net <- rep(NA, times=17)
Wins <- rep(NA, times=17)
Tries <- rep(NA, times=17)

df1 <- data.frame(Year, B1, Net, Wins, Tries)
df2 <- data.frame(Year, B2, Net, Wins, Tries)
df3 <- data.frame(Year, B3, Net, Wins, Tries)
df4 <- data.frame(Year, B4, Net, Wins, Tries)
df5 <- data.frame(Year, B5, Net, Wins, Tries)
```


## Baseline Strategy 1: always bet favorite

#### Function for single-year simulation
```{r}
bet.favorite <- function(df, wager = 10){
  # initialize
  net <- 0
  tries <- 0
  wins <- 0
  
  # for each match:
  for(i in 1:nrow(df)){
    
    # if chalk (win)
    if(df$odds.upset[i] == FALSE){
      bet.result <- wager * (df$avgF[i]-1)
      
      net <- net + bet.result
      wins <- wins + 1
      tries <- tries + 1
    }
    
    # if upset (loss)
    if(df$odds.upset[i] == TRUE){
      bet.result <- -1*wager
      
      net <- net + bet.result
      tries <- tries + 1
    }
  }
  
  # output a list
  out <- list(net, wins, tries)
  names(out) <- c("net","wins","tries")
  return(out)
}
```

#### Loop through all the seasons
```{r}
for(i in 1:length(Year)){
  season <- data %>% filter(year == Year[i])
  s.result <- bet.favorite(season, wager = 10)
  
  df1$Net[i] <- s.result[[1]]
  df1$Wins[i] <- s.result[[2]]
  df1$Tries[i] <- s.result[[3]]
}
names(df1)[2] <- "Strategy"
df1
```

NOTE OF CONCERN:
The year 2013 looks wrong. I know Will noticed some red-flags last week and made some adjustments, but I am still seeing issues here.

## Baseline Strategy 2: always bet underdog

#### Function for single-year simulation
```{r}
bet.underdog <- function(df, wager = 10){
  # initialize
  net <- 0
  tries <- 0
  wins <- 0
  
  # for each match:
  for(i in 1:nrow(df)){
    
    # if upset (win)
    if(df$odds.upset[i] == TRUE){
      bet.result <- wager * (df$avgU[i]-1)
      
      net <- net + bet.result
      wins <- wins + 1
      tries <- tries + 1
    }
    
    # if chalk (loss)
    if(df$odds.upset[i] == FALSE){
      bet.result <- -1*wager
      
      net <- net + bet.result
      tries <- tries + 1
    }
  }
  
  # output a list
  out <- list(net, wins, tries)
  names(out) <- c("net","wins","tries")
  return(out)
}
```

#### Loop through all the seasons
```{r}
for(i in 1:length(Year)){
  season <- data %>% filter(year == Year[i])
  s.result <- bet.underdog(season, wager = 10)
  
  df2$Net[i] <- s.result[[1]]
  df2$Wins[i] <- s.result[[2]]
  df2$Tries[i] <- s.result[[3]]
}
names(df2)[2] <- "Strategy"
df2
```

NOTE OF CONCERN: More issues with 2013; There is no chance we should be seeing $230,000 payout on $10 underdog bets. Also, I wonder about 2012. It is the only year we notice a profit... Hmm...


## Baseline Strategy 3: random choice of underdog/favorite

#### Function for single-year simulation
```{r}
bet.random <- function(df, wager = 10){
  # initialize
  net <- 0
  tries <- 0
  wins <- 0
  
  # for each match:
  for(i in 1:nrow(df)){
    
    choice <- sample(c("fav","dog"),size=1)
    
    if(choice == "dog"){

      # if upset (win)
      if(df$odds.upset[i] == TRUE){
        bet.result <- wager * (df$avgU[i]-1)
        
        net <- net + bet.result

        wins <- wins + 1
        tries <- tries + 1
      }
      
      # if chalk (loss)
      if(df$odds.upset[i] == FALSE){
        bet.result <- -1*wager
        
        net <- net + bet.result
        tries <- tries + 1
      }
    }
    
    if(choice == "fav"){

      # if chalk (win)
      if(df$odds.upset[i] == FALSE){
        bet.result <- wager * (df$avgF[i]-1)
  
        net <- net + bet.result
        wins <- wins + 1
        tries <- tries + 1
      }
      
      # if upset (loss)
      if(df$odds.upset[i] == TRUE){
        bet.result <- -1*wager
        
        net <- net + bet.result
        tries <- tries + 1
      }
    }
  }
  
  # output a list
  out <- list(net, wins, tries)
  
  names(out) <- c("net","wins","tries")
  return(out)
}
```

#### Loop through all the seasons
```{r}
for(i in 1:length(Year)){
  season <- data %>% filter(year == Year[i])
  s.result <- bet.random(season, wager = 10)
  
  df3$Net[i] <- s.result[[1]]
  df3$Wins[i] <- s.result[[2]]
  df3$Tries[i] <- s.result[[3]]
}
names(df3)[2] <- "Strategy"
df3

#bet.random((data%>%filter(year==2017)),wager=10)
```
More successful than betting all underdogs. Less successful than betting all favorites. We still lose money in the end.


## Baseline Strategy 4: always bet the higher ranked player

#### Function for single-year simulation
```{r}
bet.highrank <- function(df, wager = 10){
  # initialize
  net <- 0
  tries <- 0
  wins <- 0
  
  # for each match:
  for(i in 1:nrow(df)){
    
    # if 'chalk' and higher rank (win)
    if((df$rank.upset[i] == FALSE)&(df$odds.upset[i]==FALSE)){
      bet.result <- wager * (df$avgF[i]-1)
      
      net <- net + bet.result
      wins <- wins + 1
      tries <- tries + 1
    }
    
    # if 'dog' and higher rank (win)
    if((df$rank.upset[i] == FALSE)&(df$odds.upset[i]==TRUE)){
      bet.result <- wager * (df$avgU[i]-1)
      
      net <- net + bet.result
      wins <- wins + 1
      tries <- tries + 1
    }
    
    # if 'chalk' and lower rank (loss)
    if((df$rank.upset[i] == TRUE)&(df$odds.upset[i] == FALSE)){
      bet.result <- -1*wager
      
      net <- net + bet.result
      tries <- tries + 1
    }
    
    # if 'dog' and lower rank (loss)
    if((df$rank.upset[i] == TRUE)&(df$odds.upset[i] == TRUE)){
      bet.result <- -1*wager
      
      net <- net + bet.result
      tries <- tries + 1
    }
  }
  
  # output a list
  out <- list(net, wins, tries)
  names(out) <- c("net","wins","tries")
  return(out)
}
```

#### Loop through all the seasons
```{r}
for(i in 1:length(Year)){
  season <- data %>% filter(year == Year[i])
  s.result <- bet.highrank(season, wager = 10)
  
  df4$Net[i] <- s.result[[1]]
  df4$Wins[i] <- s.result[[2]]
  df4$Tries[i] <- s.result[[3]]
}
names(df4)[2] <- "Strategy"
df4
```
I'm concerned with the amount of profit we make off this strategy. It seems far to unlikely that it would be this easy. I suspect something is wrong with the variable 'upset' in the original RData, which I have converted here to 'rank.upset'.


## Baseline Strategy 5: always bet the lower ranked player

#### Function for single-year simulation
```{r}
bet.lowrank <- function(df, wager = 10){
  # initialize
  net <- 0
  tries <- 0
  wins <- 0
  
  # for each match:
  for(i in 1:nrow(df)){
    
    # if 'chalk' and lower rank (win)
    if((df$rank.upset[i] == TRUE)&(df$odds.upset[i]==FALSE)){
      bet.result <- wager * (df$avgF[i]-1)
      
      net <- net + bet.result
      wins <- wins + 1
      tries <- tries + 1
    }
    
    # if 'dog' and lower rank (win)
    if((df$rank.upset[i] == TRUE)&(df$odds.upset[i]==TRUE)){
      bet.result <- wager * (df$avgU[i]-1)
      
      net <- net + bet.result
      wins <- wins + 1
      tries <- tries + 1
    }
    
    # if 'chalk' and higher rank (loss)
    if((df$rank.upset[i] == FALSE)&(df$odds.upset[i] == FALSE)){
      bet.result <- -1*wager
      
      net <- net + bet.result
      tries <- tries + 1
    }
    
    # if 'dog' and higher rank (win)
    if((df$rank.upset[i] == FALSE)&(df$odds.upset[i] == TRUE)){
      bet.result <- -1*wager
      
      net <- net + bet.result
      tries <- tries + 1
    }
  }
  
  # output a list
  out <- list(net, wins, tries)
  names(out) <- c("net","wins","tries")
  return(out)
}
```

#### Loop through all the seasons
```{r}
for(i in 1:length(Year)){
  season <- data %>% filter(year == Year[i])
  s.result <- bet.lowrank(season, wager = 10)
  
  df5$Net[i] <- s.result[[1]]
  df5$Wins[i] <- s.result[[2]]
  df5$Tries[i] <- s.result[[3]]
}
names(df5)[2] <- "Strategy"
df5
```
It makes sence that you wouldn't be successsful always putting your money on the lower ranked player.



## View Results
```{r}
Result <- rbind(df1, df2, df3, df4, df5)
names(Result) <- c("Year","Strategy","Net Profit (w/ $10 bets)","# Successes","# Tries")

Result
boxplot(df1$Net[-13])
boxplot(df2$Net[-13])
boxplot(df3$Net[-13])
boxplot(df4$Net[-13])
boxplot(df5$Net[-13])
```

#### Comments on Results

I am concerned with the data we have for 2013. There surely is something wrong there with the filtered.men.data frame I used from the github. Another note of concern is the year 2012, where betting the underdog every time resulted in net profit. This leads to the ultimate conclusion from the baseline strategies: YOU CANNOT WIN WITH THEM... You will lose in the long run. However, betting the favorite is not quite as devastating as betting the underdog.