---
title: "Analysis of Training Data"
author: "Nick Kurtansky"
date: "11/20/2017"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

```{r, include=FALSE}
library(lmtest)
library(ggplot2)
library(dplyr)
library(tidyr)
```


### load in data
```{r}
load('filtered.men.data.RData')
data <- data.filtered
```


# begin analysis

### Clean Data
```{r}
# only include matches that sports books took bets on
data <- data %>% filter((countWinOdds > 0) & (countLoseOdds > 0))

# convert 'upset' to logical
data$upset <- as.logical(data$upset)

# upset by odds variable: odds.upset
data$odds.upset <- rep(NA, nrow(data))
for(i in 1:nrow(data)){
  data$odds.upset[i] <- ifelse(data$avgW[i] < data$avgL[i], FALSE, TRUE)
}
data$odds.upset <- as.logical(data$odds.upset)

# new column for absolute rank difference variable: abs.rank.dif
data <- data %>% mutate(abs.rank.dif = abs(WRank - LRank))

# new column for absolute odds difference variable: abs.odds.dif
data <- data %>% mutate(abs.odds.dif = abs(avgW - avgL))

# new column for odds of the favorite variable: fav.odds
data$fav.odds <- rep(NULL, nrow(data))
for(i in 1:nrow(data)){
  data$fav.odds[i] <- ifelse(as.numeric(data$odds.upset[i]) == 0, data$avgW[i], data$avgL[i])
}

# new column for variable: year
data$year <- rep(NA, nrow(data))
for(i in 1:nrow(data)){
  year <- substr(x = data$date[i], start = 1, stop = 4)
  data$year[i] <- year
}

# convert 'Best.of' to Factor variable
data$Best.of <- as.factor(data$Best.of)

str(data)
```

### What is the raw probability of an upset?
```{r}
sum(data$odds.upset/nrow(data))
```
Upset occurs with probability 0.3283341... Hence, odds have a success rate p = 0.6716659

### Training data from 2001 through 2014
```{r}
train <- data %>% filter(!(year %in% c("2015","2016","2017")))
test <- data %>% filter(year %in% c("2015","2016","2017"))

# Make adaptions to the training data
#train <- train %>% filter(!(Round %in% c("1st Round","2nd Round")))
```

### Tables (using training data)
```{r}
# Row-proportions: Best.of vs. odds.upset
prop.table(table(train$Best.of, train$odds.upset),1)

# Row-proportions: Surface vs. odds.upset
prop.table(table(train$Surface, train$odds.upset),1)

# Row-proportions: Round vs. odds.upset
prop.table(table(train$Round, train$odds.upset),1)

# Row-proportions: Series vs. odds.upset
prop.table(table(train$Series,train$odds.upset),1)
```


### Graphs
```{r}
ggplot(data = train, aes(x = odds.upset, y = abs.rank.dif)) + geom_boxplot(fill = "darkgreen") + labs(y = "difference in player ranks", x = "Upset") + ylim(0,200) + facet_wrap(~Round)

ggplot(data = train, aes(x = odds.upset, y = fav.odds)) + geom_boxplot(fill = "darkgreen") + labs(y = "Odds of favorite", x = "Upset") + ylim(1,2) + facet_wrap(~Round)



#plot(train$fav.odds, train$abs.rank.dif)

#ggplot(data = train, aes(x = odds.upset)) + geom_bar(aes(fill = odds.upset), stat="count") +  geom_text(stat='count',aes(label=..count..),vjust=-1) + scale_y_continuous(limits = c(0,20000)) + facet_wrap(~Surface)

#ggplot(data = train, aes(x = odds.upset)) + geom_bar(aes(fill = odds.upset), stat="count") +  geom_text(stat='count',aes(label=..count..),vjust=-1) + scale_y_continuous(limits = c(0,20000)) + facet_wrap(~Round)

#ggplot(data = train, aes(x = odds.upset)) + geom_bar(aes(fill = odds.upset), stat="count") +  geom_text(stat='count',aes(label=..count..),vjust=-1) + scale_y_continuous(limits = c(0,20000)) + facet_wrap(~Best.of)
```

### Models
```{r}
model.1 <- glm(odds.upset~abs.rank.dif + abs.odds.dif + Best.of + Round + Surface, family = binomial, data = train)
summary(model.1)

model.2 <- glm(odds.upset~abs.rank.dif + Best.of + Round + Surface, data = train)
summary(model.2)
```

